<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quiz History</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<h1>Quiz History</h1>
<div id="historyContainer"></div>

<!-- Navigation buttons -->
<div class="navigation-buttons">
    <button onclick="window.location.href='form-creation.html'">Create a New Quiz</button>
    <button onclick="window.location.href='flashcards.html'">Go to Flashcards</button>
</div>

<!-- Delete history button -->
<div class="navigation-buttons">
    <button onclick="deleteHistory()">Delete Quiz History</button>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        loadQuizHistory();
    });

    function loadQuizHistory() {
        fetch('/get-quiz-history')
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch quiz history.");
                }
                return response.json();
            })
            .then(quizzes => {
                const historyContainer = document.getElementById("historyContainer");
                historyContainer.innerHTML = ""; // Clear previous history

                if (quizzes.length === 0) {
                    historyContainer.innerHTML = "<p>No quizzes found in history.</p>";
                    return;
                }

                quizzes.forEach((quiz, index) => {
                    const quizBlock = document.createElement("div");
                    quizBlock.classList.add("quiz-block");
                    quizBlock.innerHTML = `
                        <h2>Quiz ${index + 1}: ${quiz.title}</h2>
                        <p><strong>Description:</strong> ${quiz.description}</p>
                        <p><strong>Number of Questions:</strong> ${quiz.questions.length}</p>
                        ${
                        quiz.description.includes("Score Received")
                            ? `<p><strong>Score:</strong> ${
                                quiz.description.match(/Score Received: (\d+)%/)[1]
                            }%</p>`
                            : ""
                    }
                    `;
                    //---------------------------------------------ticket 1.2 SP3
                    const scoreMatch = quiz.description.match(/Score Received: (\d+)%/);
                    const score = scoreMatch ? parseInt(scoreMatch[1], 10) : null;

                    if (score && score >= 80) { // Threshold for certificate eligibility
                        const certificateButton = document.createElement("button");
                        certificateButton.innerText = "View Certificate";
                        certificateButton.onclick = () => {
                            const dataToStore = {
                                title: quiz.title,
                                score: score,
                                date: new Date().toLocaleDateString()
                            };
                            console.log("Storing certificate data:", dataToStore); // Debugging line
                            localStorage.setItem("certificateData", JSON.stringify(dataToStore));
                            window.location.href = "certificate-template.html";
                        };
                        quizBlock.appendChild(certificateButton);
                    }
                    //------------------------------------------------ ticket 1.2 SP3

                    historyContainer.appendChild(quizBlock);
                });
            })
            .catch(error => console.error("Error fetching quiz history:", error));
    }

    function deleteHistory() {
        fetch("/delete-quiz-history", { method: "DELETE" })
            .then(response => {
                if (response.ok) {
                    alert("Quiz history deleted successfully!");
                    location.reload();
                } else {
                    alert("Failed to delete quiz history.");
                }
            })
            .catch(error => console.error("Error deleting history:", error));
    }
</script>
</body>
</html>
